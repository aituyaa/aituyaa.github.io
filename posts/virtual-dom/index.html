<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="Virtual Dom - https://loveminimal.github.io/posts/virtual-dom/">
    <meta name="author" content="Jack - https://loveminimal.github.io/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>Virtual Dom</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://loveminimal.github.io/style.min.588bdbe244863f48f211eae6ac79640e39689f34e9568c6f2789c5519ab60956.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate ">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"isSingleColumnOfPostList": true,
		"hasFoldAllCodeBlocks": false,
		"svgColor": "",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            Virtual Dom
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill="#6c757d" p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill="#6c757d"></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill="#6c757d"></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill="#6c757d" p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill="#6c757d" p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill="#6c757d" p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill="#6c757d" p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill="#6c757d"></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">















<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2020-12-02&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2023-02-28&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            3546 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            17 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/javascript">JavaScript</a>
			
		</div>
		<div class="tag">
			
			
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://loveminimal.github.io/posts/modular-programming/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://loveminimal.github.io/posts/sdk/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#what-exactly-is-the-dom1">What, exactly, is the DOM?<a href="https://bitsofco.de/what-exactly-is-the-dom/">1</a></a>
      <ul>
        <li><a href="#how-is-a-web-page-built">How is a web page built?</a></li>
        <li><a href="#how-is-the-dom-created">How is the DOM created?</a></li>
        <li><a href="#what-the-dom-is-not">What the DOM is not</a></li>
        <li><a href="#recap">Recap</a></li>
      </ul>
    </li>
    <li><a href="#understanding-the-critical-rendering-path2">Understanding the Critical Rendering Path<a href="https://bitsofco.de/understanding-the-critical-rendering-path/">2</a></a>
      <ul>
        <li><a href="#1constructing-the-dom-tree">1.Constructing the DOM Tree</a></li>
        <li><a href="#2constructing-the-cssom-tree">2.Constructing the CSSOM Tree</a></li>
        <li><a href="#3running-javascript">3.Running JavaScript</a></li>
        <li><a href="#4creating-the-render-tree">4.Creating the Render Tree</a></li>
        <li><a href="#5generating-the-layout">5.Generating the Layout</a></li>
        <li><a href="#6painting">6.Painting</a></li>
        <li><a href="#putting-it-all-together">Putting it All Together</a></li>
      </ul>
    </li>
    <li><a href="#understanding-the-virtual-dom3">Understanding the Virtual DOM<a href="https://bitsofco.de/understanding-the-virtual-dom/">3</a></a>
      <ul>
        <li><a href="#why-do-we-need-a-virtual-dom">Why do we need a virtual DOM?</a></li>
        <li><a href="#what-does-a-virtual-dom-look-like">What does a virtual DOM look like?</a></li>
        <li><a href="#under-the-hood-of-the-virtual-dom">Under the hood of the virtual DOM</a></li>
        <li><a href="#the-virtual-dom-and-frameworks">The virtual DOM and frameworks</a></li>
        <li><a href="#the-dom-vs-the-virtual-dom">The DOM vs the virtual DOM</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <p>Before learning Virtual DOM, lets take a look at DOM.</p>
<h2 id="what-exactly-is-the-dom1">What, exactly, is the DOM?<a href="https://bitsofco.de/what-exactly-is-the-dom/">1</a></h2>
<p>The Document Object Model, or the &ldquo;DOM&rdquo;, is an interface to web pages. It is essentially an API to the page, allowing programs to read an manipulate the page&rsquo;s content, structure, and styles. Let&rsquo;w break this down.</p>
<h3 id="how-is-a-web-page-built">How is a web page built?</h3>
<p>How a browser goes from a source HTML document to displaying a styled and interactive page in the viewport is called the <em>&ldquo;Critical Rendering Path&rdquo;</em>. Although this process can be broken down into several steps, as I cover in my article on <a href="https://bitsofco.de/understanding-the-critical-rendering-path/">Understanding the Critical Rendering Path</a>, these steps can be roughy grouped into two stages.</p>
<p>The first stage involves the browser parsing the document to determine what will ultimately be rendered on the page, and the second stage involves the browser performing the render.</p>
<img src="imgs/vdom-1.png" width="660" height="" />
<p>The result of the first stage is what is called a <em>&ldquo;render tree&rdquo;</em>.</p>
<p>The render tree is a representation of the HTML elements that will be rendered on the page and their related styles. In order to build this tree, the browser needs two things:</p>
<ol>
<li>The <em>CSSOM</em>, a representation of the styles associated with elements;</li>
<li>The <em>DOM</em>, a representation of the elements.</li>
</ol>
<h3 id="how-is-the-dom-created">How is the DOM created?</h3>
<img src="imgs/vdom-2.png" width="300" style="float: right; margin-left: 8px;" />
<p>And what does it look like?</p>
<p>The DOM is an object-based representation of the source HTML document. It has some differences, as we will see below, but it is essentially an attempt to convert the structure and content of the HTML document into an object model that can be used by various programs.</p>
<p>The object structure of the DOM is represented by what is called a <em>&ldquo;node tree&rdquo;</em>. It is so called because it can be thought of as a tree with a single parent stem that branches out into several child branches, each which may have leaves. In this case, the parent &ldquo;stem&rdquo; is the root =<html>= element, the child &ldquo;branches&rdquo; are the nested elements, and the &ldquo;leaves&rdquo; are the content within the elements.</p>
<p>Let&rsquo;s take this HTML document as an example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!doctype html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span> <span style="color:#008080">lang</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">title</span>&gt;My first web page&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">h1</span>&gt;Hello, world!&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">p</span>&gt;How are you?&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p>This document can be represented as the above node tree.</p>
<h3 id="what-the-dom-is-not">What the DOM is not</h3>
<p>In the example I gabe above, it seems like the DOM is a 1-to-1 mapping of the source HTML document or what you see your DevTools. However, as I mentioned, there are differences. In order to fully understand what the DOM <em>is</em>, we need to look at what it is <em>not</em>.</p>
<p><em>1.The DOM is not your source HTML</em></p>
<p>Although the DOM is created from the source HTML document, it is not always exactly the same. There are two instances in which the DOm can be different from the source HTML.</p>
<p>(1) When the HTML is not valid</p>
<p>The DOM is an interface for <em>valid</em> HTML documents. During the process of creating the DOM, the browser may correct some invalidities in the HTML code. Like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!doctype html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>Hello, world!
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><img src="imgs/vdom-3.png" width="200" style="float: right; margin-left: 8px;" />
<p>The document is missing a <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code> element, which is a requirement for valid HTML. If we look at the resulting DOM tree, we will see that this has been corrected:</p>
<p>(2) When the DOM is modified by JavaScript</p>
<p>Beside being an interface to viewing the content of an HTML document, the DOM can alse modified, making it a living resource.</p>
<p>We can, for example, crate additional nodes to the DOM using JavaScript.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> newParagraph <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.crateElement(<span style="color:#d14">&#39;p&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> paragraphContent <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.createTextNode(<span style="color:#d14">&#39;I\&#39;m new!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>newParagraph.appendChild(paragraphContent)
</span></span><span style="display:flex;"><span><span style="color:#0086b3">document</span>.body.appendChild(newParagraph)
</span></span></code></pre></div><p>This will update the DOM, but of course not our HTML document.</p>
<p><em>2.The DOM is not what you see in the browser (i.e., the render tree)</em></p>
<p>What you see in the browser viewport is the render tree which, as I mentioned, is a combination of the DOM and the CSSOM.</p>
<p>What really separates the <em>DOM</em> from the <em>render tree</em>, is that the latter only consists of what will eventually be painted on the screen.</p>
<p>Becuase the render tree is only concerned with what is rendered, it excludes elements that are visually hidden. For example, elements that have =display: none= styles associated to them.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!doctype html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span> <span style="color:#008080">lang</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">h1</span>&gt;Hello, world!&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">p</span> <span style="color:#008080">style</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;display: none;&#34;</span>&gt;How are you?&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p>The DOM will include the <code>&lt;p&gt;</code> element:</p>
<img src="imgs/vdom-4.png" width="250" height="" />
<img src="imgs/vdom-5.png" width="200" style="float: right; margin-left: 8px; border: 3px solid #acf;" />
<p>However, the render tree, and therefore what is seen in the viewport, will not include that element.</p>
<p><em>3.The DOM is not what is in DevTools</em></p>
<p>This differentce is a bit more minuscule because the DevTools element inspector provides the closest approximation to the DOM that we have in the browser. However, the DevTools inspector includes addtional information that isn&rsquo;t in the DOM.</p>
<p>The best example of this is CSS pseudo-elements. Pseudo-elements created using the =::before= and =::after= selectors form part of the CSSOM and render tree, but are not technically part of the DOM. This is because the DOM is built from the source HTML document alone, not including the styles applied to the element.</p>
<p>Despite the fact that pseudo-elements are not part of the DOM, they are in our devtools element inspector.</p>
<img src="imgs/vdom-6.png" width="800" />
<p>This is why pseudo-elements cannot be targetted by JavaScript, because they are not part of the DOM.</p>
<h3 id="recap">Recap</h3>
<p>The DOM is an interface to an HTML document. It is used by browsers as a first step towards determining what to render in the viewport, and by Javascript programs to modify the content, structure, or styling of the page.</p>
<p>Although similar to other forms of the source HTML document, the DOM is different in a number of ways:</p>
<ul>
<li>It is always valid HTML</li>
<li>It is a living model that can be modifed by Javascript</li>
<li>It doesn&rsquo;t include pseudo-elements (e.g. ::after)</li>
<li>It does include hidden elements (e.g. with display: none)</li>
</ul>
<h2 id="understanding-the-critical-rendering-path2">Understanding the Critical Rendering Path<a href="https://bitsofco.de/understanding-the-critical-rendering-path/">2</a></h2>
<p>When a browser receives the HTML response for a page from the server, there are lot of steps to be taken before pixels are drawn on the screen. This sequence the browser needs to run through for the initial paint of the page is called the <em>&ldquo;Critical Rendering Path&rdquo;</em>.</p>
<blockquote>
<p>　*Tip: we will use CRP represent Critical Rendering Path.</p>
</blockquote>
<p>Knowledge of the CRP is incredibly useful for understanding how a site&rsquo;s performance can be improved. There are 6 stages to the CRP:</p>
<pre tabindex="0"><code>1. Constructing the DOM Tree
2. Construting the CSSOM Tree
3. Running JavaScript
4. Creating the Render Tree
5. Generating the Layout
6. Painting
</code></pre><img src="imgs/vdom-7.png" width="760" />
<h3 id="1constructing-the-dom-tree">1.Constructing the DOM Tree</h3>
<p>The DOM (Document Object Model) Tree is an Object representation of the fully parsed HTML page.</p>
<p>Starting with the root element, <code>&lt;html&gt;</code>, nodes are created for each element/text on the page. Elements nested within other elements are represented as child nodes and each node contains the full attributes for that element. For example, an <code>&lt;a&gt;</code> element will have the <code>href</code> attribute associated with it&rsquo;s node.</p>
<p>Take, for example, this sample document:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">title</span>&gt;Understanding the Critical Rendering Path&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">link</span> <span style="color:#008080">rel</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;stylesheet&#34;</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;style.css&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">header</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">h1</span>&gt;Understanding the Critical Rendering Path&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">header</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">main</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">h2</span>&gt;Introduction&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">p</span>&gt;Lorem ipsum dolor sit amet&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">main</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">footer</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">small</span>&gt;Copyright 2017&lt;/<span style="color:#000080">small</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">footer</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p>This will create the following DOM Tree:</p>
<img src="imgs/vdom-8.png" width="720" />
<p>A good thing about HTML is that it can be executed in parts. The full document doesn&rsquo;t have to be loaded for content to start appearing on the page. However, other resources, CSS and JavaScript, can block the render of the page.</p>
<h3 id="2constructing-the-cssom-tree">2.Constructing the CSSOM Tree</h3>
<p>The CSSOM (CSS Object Model) is an Object representation of the styles associated with the DOM. It is represented in a similar way to the DOM, but with the associated styles for each node, whether they explicitly declared or implicitly inherited, included.</p>
<p>In the =<code>tyle.css</code> file from the document mentioned above, we have the following styles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#000080">body</span> { <span style="color:#000;font-weight:bold">font-size</span>: <span style="color:#099">18</span><span style="color:#458;font-weight:bold">px</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">header</span> { <span style="color:#000;font-weight:bold">color</span>: <span style="color:#000;font-weight:bold">plum</span>; }
</span></span><span style="display:flex;"><span><span style="color:#000080">h1</span> { <span style="color:#000;font-weight:bold">font-size</span>: <span style="color:#099">28</span><span style="color:#458;font-weight:bold">px</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">main</span> { <span style="color:#000;font-weight:bold">color</span>: <span style="color:#000;font-weight:bold">firebrick</span>; }
</span></span><span style="display:flex;"><span><span style="color:#000080">h2</span> { <span style="color:#000;font-weight:bold">font-size</span>: <span style="color:#099">20</span><span style="color:#458;font-weight:bold">px</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080">footer</span> { <span style="color:#000;font-weight:bold">display</span>: <span style="color:#000;font-weight:bold">none</span>; }
</span></span></code></pre></div><p>This will create the following CSSOM Tree:</p>
<img src="imgs/vdom-9.png" width="720" />
<p>CSS is considered a <em>&ldquo;render blocking resource&rdquo;</em>. This means that the [[*4.Creating the Render Tree][Render Tree (see below)]] cannot be constructed without first fully parsing the resource.</p>
<p>Unlike HTML, CSS cannot be used in parts because of its inherit cascading nature. Styles defined later in the document can override and change styles that were previously defined. So, if we start using CSS styles defined earlier in the stylesheet before the entirety of the stylesheet has been parsed, we may get a situation where the wrong CSS is being applied.</p>
<p><em>This means that CSS must be fully parsed before we can move on to the next stage.</em></p>
<p>CSS files are only considered render blocking if they apply to the current device. The <code>&lt;link rel=&quot;stylesheet&quot;&gt;</code> tag can accept a <code>media</code> attribute, in which we can specify any media query which the styles within apply to. If, for example, we have a stylesheet with a media attribute of <code>orientation: landscape</code>, and we are viewing the page in portrait mode, that resource will not be considered render blocking.</p>
<p>CSS can also be <em>&ldquo;script blocking&rdquo;</em>. This is because JavaScript files must wait until the CSSOM has been constructed before it can run.</p>
<h3 id="3running-javascript">3.Running JavaScript</h3>
<p>JavaScript is considered a <em>&ldquo;parser blocking resource&rdquo;</em>. This means that the parsing of the HTML document itself is blocked by JavaScript.</p>
<p>When the parser reaches a <code>&lt;script&gt;</code> tag, whether that be internal or external, it stops to fetch (if it is external) and run it. This why, if we have a JavaScript file that references elements within the document, it must be placed after the appearance of that document.</p>
<p>To avoid JavaScript being parse blocking, it can be loaded asynchronously be applying the <code>async</code> attribute.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#000080">script</span> <span style="color:#008080">async</span> <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;script.js&#34;</span>&gt;&lt;/<span style="color:#000080">script</span>&gt;
</span></span></code></pre></div><h3 id="4creating-the-render-tree">4.Creating the Render Tree</h3>
<p>The Render Tree is a combination of both the DOM and CSSOM. It is a Tree that represents what will be eventually rendered on the page. This means that it only captures the visible content and will not include, for example, elements that have been hidden with CSS using <code>display: none</code>.</p>
<p>Using the example DOM and CSSOM above, the following Render Tree will be created:</p>
<img src="imgs/vdom-10.png" width="720" />
<h3 id="5generating-the-layout">5.Generating the Layout</h3>
<p>The Layout is what determines <em>what the size of the viewport is</em> , which provides context for CSS styles that are dependent on it, e.g. percentage or viewport units. The viewport size is determined by meta viewport tag provided in the document head or, if no tag is provided, the default viewport width of 980px is used.</p>
<p>For example, the most common meta viewport value is to set the viewport size to correspond to the device width:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#000080">meta</span> <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;viewport&#34;</span> <span style="color:#008080">content</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;width=device-width,initial-scale=1&#34;</span>&gt;
</span></span></code></pre></div><p>If the user visits the webpage on a device with a width of, for example, 1000px, then sizes will be based on that unit. Half the viewport will be 500px, 10vw will be 100px, and so on.</p>
<h3 id="6painting">6.Painting</h3>
<p>Finally, in the Painting step, the visible content of the page can be converted to pixels to be displayed on the screen.</p>
<p>How much time the paint step takes depends on the size of the DOM, as well as what styles are applied. Some styles require more work to execute than others. For example, a complicated gradient background-image will require more time than a simple solid background colour.</p>
<h3 id="putting-it-all-together">Putting it All Together</h3>
<p>To see the Critical Rendering Path in process, we can inspect it in DevTools. In Chrome, it is under the <em>Timeline</em> tab (in Canary, and soon to be Chrome stable, it&rsquo;s renamed <em>Performance</em>).</p>
<p>Take for example, our sample HTML from above (width an added <code>&lt;script&gt;</code> tag):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">title</span>&gt;Understanding the Critical Rendering Path&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">link</span> <span style="color:#008080">rel</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;stylesheet&#34;</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;style.css&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">header</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">h1</span>&gt;Understanding the Critical Rendering Path&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">header</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">main</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">h2</span>&gt;Introduction&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">p</span>&gt;Lorem ipsum dolor sit amet&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">main</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">footer</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">small</span>&gt;Copyright 2017&lt;/<span style="color:#000080">small</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">footer</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">script</span> <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;main.js&#34;</span>&gt;&lt;/<span style="color:#000080">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p>If we look at the Event Log for the page load, this is what we get:</p>
<img src="imgs/vdom-11.png" width="800" />
<ol>
<li><em>Send Request</em> - GET request sent for index.html</li>
<li><em>Parse HTML</em> and <em>Send Request</em> - Begin parsing of HTML and DOM construction. Send GET request for <code>style.css</code> and <code>main.js</code></li>
<li><em>Parse Stylesheet</em> - CSSOM created for <code>style.css</code></li>
<li><em>Evaluate Script</em> - Evaluate <code>main.js</code></li>
<li><em>Layout</em> - Generate Layout based on meta viewport tag in HTML</li>
<li><em>Paint</em> - Paint pixels on document</li>
</ol>
<p>Based on this information, we can make decisions on how to optimize the Critical Rendering Path. I will go into some of these techniques in later articles.</p>
<h2 id="understanding-the-virtual-dom3">Understanding the Virtual DOM<a href="https://bitsofco.de/understanding-the-virtual-dom/">3</a></h2>
<p>I&rsquo;ve recently been writing about what exactly the DOM and the shodow DOM are and how they differ.</p>
<p>To recap, the Document Object Model is an object-based representation of an HTML document and an interface to mainpulating that object.</p>
<p>The shadow DOM can be thought of as a &ldquo;lite&rdquo; version of the DOM. It is also an object-based representation of HTML elements, but not of a full standalone document. Instead, the shadow DOM allows us to separate our DOM into smaller, encapsulated bits that can be used across HTML documents.</p>
<p>Another similar term you may have come across is the <em>&ldquo;virtual DOM&rdquo;</em>.</p>
<p>Although the concep has been around for several years, it was made more popular by its use in the React framework. In this article, I will cover exactly what the virtual DOM is, how it differs from the original DOM, and how it it used.</p>
<h3 id="why-do-we-need-a-virtual-dom">Why do we need a virtual DOM?</h3>
<p>To understand why the concept of the virtual DOM arose, let&rsquo;s revisit the original DOM.</p>
<p>As I mentioned, there are two parts to the DOM:</p>
<ul>
<li>the object-based representation of the HTML document, and</li>
<li>the API to manipulating that object.</li>
</ul>
<p>For example, let&rsquo;s take this simple HTML document with an unordered list and one list item.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!doctype html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span> <span style="color:#008080">lang</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#000080">head</span>&gt;&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">ul</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;list&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">li</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;list__item&#34;</span>&gt;List item&lt;/<span style="color:#000080">li</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">ul</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre></div><p>This document can be represented as the following DOM tree:</p>
<img src="imgs/vdom-12.png" width="260" />
<p>Let&rsquo;s say we want to modify the content of the first list item to <em>&ldquo;List item one&rdquo;</em> and also add a second list item. To do this, we will need use the DOM APIs to find the elements we want to update, create the new elements, add attributes and content, then finally update the DOM elements themselves.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> listItemOne <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.getElementsByClassName(<span style="color:#d14">&#39;list__item&#39;</span>)[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>listItemOne.textContent <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;List item one&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.getElementsByClassName(<span style="color:#d14">&#39;list&#39;</span>)[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> listItemTwo <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.createElement(<span style="color:#d14">&#39;li&#39;</span>)
</span></span><span style="display:flex;"><span>listItemTwo.classList.add(<span style="color:#d14">&#39;list__item&#39;</span>)
</span></span><span style="display:flex;"><span>listItemTwo.textContent <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;List item two&#39;</span>
</span></span><span style="display:flex;"><span>list.appendChild(listItemTwo)
</span></span></code></pre></div><p><em>The DOM wasn&rsquo;t made for this&hellip;</em></p>
<p>When the first specification for the DOM was released in 1998, we built and managed web pages in very differently. There was far less reliance on the DOM APIs to create and update the page content as frequently as we do today.</p>
<p>Simple methods such as =document.getElementsByClassName()= are fine to use on a small scale, but if we are updating muliple elements on a page every few seconds, it can start to become really expensive to constantly query and update the DOM.</p>
<p>Even further, because of the way the APIs are setup, it is usually simpler to perform more expensive operations where we update larger parts of the doucment than to find and update the specific elements. Going back to our list example, it is in some ways easier to replace the entire unordered list with a new one than to modify the specific elements.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.getElementsByClassName(<span style="color:#d14">&#39;list&#39;</span>)[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>list.innerHTML <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;li class=&#34;list__item&#34;&gt;List item one&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&lt;li class=&#34;list__item&#34;&gt;List item two&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  `</span>
</span></span></code></pre></div><p>In this particular example, the performance difference between the methods is probably insignificant. However, as the size of the web page grows, it becomes more important to only select and update what is needed.</p>
<p><em>&hellip;but the virtual DOM was!</em></p>
<p>The virtual DOM was created to solve these problems of needing to frequently update the DOM in a more performant way. Unlike the DOM or the shadow DOM, the virtual DOM isn&rsquo;t an official specification, but rather a new method of interfacing with the DOM.</p>
<p><em>A virtual DOM can be thought of as a copy of the original DOM.</em> This copy can be frequently manipulated and upated, without using the DOM APIs. Once all the updates have been made to the virtual DOM, we can look at what specific changes need to be made to the original DOM and make them in a targetted and optimised way.</p>
<h3 id="what-does-a-virtual-dom-look-like">What does a virtual DOM look like?</h3>
<p>The name &ldquo;virtual DOM&rdquo; tends to add to the mystery of what the concept actually is. <em>In fact, a virtual DOM is just a regular JavaScript object.</em></p>
<p>Let&rsquo;s revisit the DOM tree we created earlier:</p>
<img src="imgs/vdom-12.png" width="260" />
<p>This tree can also be represented as a JavaScript object.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> vdom <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;html&#39;</span>,
</span></span><span style="display:flex;"><span>	children<span style="color:#000;font-weight:bold">:</span> [
</span></span><span style="display:flex;"><span>		{ tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;head&#39;</span>},
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;body&#39;</span>,
</span></span><span style="display:flex;"><span>			children<span style="color:#000;font-weight:bold">:</span> [
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;ul&#39;</span>,
</span></span><span style="display:flex;"><span>					attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list&#39;</span> },
</span></span><span style="display:flex;"><span>					children<span style="color:#000;font-weight:bold">:</span> [
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;li&#39;</span>,
</span></span><span style="display:flex;"><span>							attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> },
</span></span><span style="display:flex;"><span>							textContent<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;List item&#39;</span>
</span></span><span style="display:flex;"><span>						}   <span style="color:#998;font-style:italic">// end li
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					]
</span></span><span style="display:flex;"><span>				}   <span style="color:#998;font-style:italic">// end ul
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			]
</span></span><span style="display:flex;"><span>		}   <span style="color:#998;font-style:italic">// end body
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	]
</span></span><span style="display:flex;"><span>}   <span style="color:#998;font-style:italic">// end html
</span></span></span></code></pre></div><p>We can think of this object as our virtual DOM. Like the original DOM, it is an object-based representation of our HTML document. But since it is a plain JavaScript object, we can manipulate it freely and frequently without touching the actual DOM until we need to.</p>
<p>Instead of using one object for the entire object, it is more common to work with small sections of the virtual DOM. For example, we may work on a <em>list</em> component, which would corespond to our unordered list element.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> list <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	tabName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;ul&#39;</span>,
</span></span><span style="display:flex;"><span>	attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list&#39;</span> },
</span></span><span style="display:flex;"><span>	children<span style="color:#000;font-weight:bold">:</span> [
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;li&#39;</span>,
</span></span><span style="display:flex;"><span>			attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> },
</span></span><span style="display:flex;"><span>			textContent<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;List item&#39;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="under-the-hood-of-the-virtual-dom">Under the hood of the virtual DOM</h3>
<p>Now that we&rsquo;ve seen what a virtual DOM looks like, how does it work to solve the performance and usability problems of the DOM?</p>
<p>As I mentioned, we can use the virtual DOM to single out the specific changes that need to be made to the DOM and make those specific updates alone. Let&rsquo;s go back to our unordered list example and make the same changes we did using the DOM API.</p>
<p>The first thing we would do is make a copy of the virtual DOM, containing the changes we want to make. Since we don&rsquo;t need to use the DOM APIs, we can actually just create a new object alltogether.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> copy <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;ul&#39;</span>,
</span></span><span style="display:flex;"><span>	attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list&#39;</span> },
</span></span><span style="display:flex;"><span>	children<span style="color:#000;font-weight:bold">:</span> [
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;li&#39;</span>,
</span></span><span style="display:flex;"><span>			attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> },
</span></span><span style="display:flex;"><span>			textContent<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;List item one&#39;</span>
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			tagName<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;li&#39;</span>,
</span></span><span style="display:flex;"><span>			attributes<span style="color:#000;font-weight:bold">:</span> { <span style="color:#000;font-weight:bold">class</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> },
</span></span><span style="display:flex;"><span>			textContent<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;List item two&#39;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This <em>copy</em> is used to create what is called a &ldquo;diff&rdquo; between the original virtual DOM, in this case the <em>list</em> , and the updated one. A diff could look something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> diffs <span style="color:#000;font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		newNode<span style="color:#000;font-weight:bold">:</span> { <span style="color:#998;font-style:italic">/* new version of list item one */</span> },
</span></span><span style="display:flex;"><span>		oldNode<span style="color:#000;font-weight:bold">:</span> { <span style="color:#998;font-style:italic">/* original version of list item one */</span> },
</span></span><span style="display:flex;"><span>		index<span style="color:#000;font-weight:bold">:</span> <span style="color:#998;font-style:italic">/* index of element in parent&#39;s list of child nodes */</span>
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		newNode<span style="color:#000;font-weight:bold">:</span> { <span style="color:#998;font-style:italic">/* list item two */</span> },
</span></span><span style="display:flex;"><span>		index<span style="color:#000;font-weight:bold">:</span> { <span style="color:#998;font-style:italic">/* */</span> }
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>This diff provides instructions for how to update the actual DOM. Once all the diffs are collected, we can batch changes to the DOM, making only the updates that are needed.</p>
<p>For example we could loop through each diff and either add a new child or update an old one depending on what the diff specifies.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> domElement <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.getElementsByClassName(<span style="color:#d14">&#39;list&#39;</span>)[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diffs.forEach((diff) =&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	cosnt newElement <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">document</span>.createElement(diff.newNode.tagName)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">/* Add attributes ... */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> (diff.oldNode) {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// If there is an old version, replace it with the new version
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		domElement.replaceChild(diff.newNode, diff.index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// if no old version exists, create a new node
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		domElement.appendChild(diffNode)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Note that this is a really simplified and stripped-back version of how a virtual DOM could work and there are lot of cases I didn&rsquo;t cover here.</p>
<h3 id="the-virtual-dom-and-frameworks">The virtual DOM and frameworks</h3>
<p>It&rsquo;s more common to work with the virtual DOM via a framework, rather than interfacing with it directly as I showed in the example above.</p>
<p>Frameworks such as React and Vue use the virtual DOM concept to make more performant updates to the DOM. For example, our <em>list</em> component can be written in React in the following way.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> React from <span style="color:#d14">&#39;react&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> ReactDOM from <span style="color:#d14">&#39;react-dom&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> list <span style="color:#000;font-weight:bold">=</span> React.createElement(
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#39;ul&#39;</span>, { className<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list&#39;</span> },
</span></span><span style="display:flex;"><span>	React.createElement(<span style="color:#d14">&#39;li&#39;</span>, { className<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> }, <span style="color:#d14">&#39;List item&#39;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReactDOM.render(list, <span style="color:#0086b3">document</span>.body)
</span></span></code></pre></div><p>If we wanted to update our list, we could just rewrite the entire list template, and call =ReactDOM.render()= again, passing in the new list.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> newList <span style="color:#000;font-weight:bold">=</span> React.createElement(
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#39;ul&#39;</span>, { className<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list&#39;</span> },
</span></span><span style="display:flex;"><span>	React.createElement(<span style="color:#d14">&#39;li&#39;</span>, { className<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> }, <span style="color:#d14">&#39;List item one&#39;</span>),
</span></span><span style="display:flex;"><span>	React.createElement(<span style="color:#d14">&#39;li&#39;</span>, { className<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#39;list__item&#39;</span> }, <span style="color:#d14">&#39;List item two&#39;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setTimeout(() =&gt; ReactDOM.render(newList, <span style="color:#0086b3">document</span>.body), <span style="color:#099">5000</span>)
</span></span></code></pre></div><p>Because React uses the virtual DOM, even though we are re-rendering the entire template, only the parts that actually change are updated. If we look at our developer tools when the change happens, we will see the specific elements and the specific parts of the elements that change.</p>
<h3 id="the-dom-vs-the-virtual-dom">The DOM vs the virtual DOM</h3>
<p>To recap, the virtual DOM is a tool that enables us to interface with DOM elements in an easier and more performant way. It is a JavaScript object representation of the DOM, which we can modify as frequently as we need to. Changes made to this object are then collated, and modifications to the actual DOM are targetted and made less often.</p>
    </div>

    

    

    <div class="container-prevnext">
    <div><a href="https://loveminimal.github.io/posts/modular-programming/">← 模块化编程</a></div>
    <div><a href="https://loveminimal.github.io/posts/sdk/">打造 SDK  →</a></div>
</div>
    
    <div class="container-comment">
	<script src="https://utteranc.es/client.js"
        repo="loveminimal/comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
	</script>
</div>

    
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        豫ICP备2022002918号-1
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
    
</div></div>
    </body>
</html>
